var _=require("underscore"),mqtt=require("mqtt"),moment=require("moment"),i=require("debug")("Gateway:inflow"),o=require("debug")("Gateway:outflow"),g=require("debug")("Gateway:normal"),m=require("debug")("Gateway:mqtt"),e=require("debug")("Gateway:errors"),util=(moment=require("moment"),require("util")),EventEmitter=require("events"),uniqid=require("uniqid"),lzw=require("lzwcompress"),REMOTE_ADDR=null;function Gateway(){this.gate_id=uniqid(),EventEmitter.call(this)}function node(opt){var _node=this;function handshake(_REMOTE){if(_node.auth){_REMOTE.publish("pingzee/dead/gateway/software",JSON.stringify({created_at:moment().format("hh:mm:ss:SS a  ddd"),key:_node.key,app_name:_node.app_name,gate_id:_node.gate_id,session:_node.session})),m("Mqtt reconnected"),_node.marker=uniqid(_node.key+"-");var check={data:{msg:"Handshaking ",auth:!1,custom:[],channels:_node.channels},info:{created_at:_node.created_at,gate_id:_node.gate_id,app_name:_node.app_name,session:_node.session,key:_node.key,multikey:_node.multikey,multi:_node.multi,type:_node.type},action:"handshake",to:"exchange",from:"sgtway",marker:_node.marker},raw_data=JSON.stringify(lzw.pack(check));_REMOTE.publish("pingzee/auth/request/"+_node.type,raw_data),_REMOTE.subscribe("pingzee/auth/"+_node.gate_id+"/"+_node.session+"/"+_node.type+"/response")}else{m("Mqtt connected"),_node.marker=uniqid(_node.key+"-");check={data:{msg:"Handshaking ",auth:!1,custom:[],channels:_node.channels},info:{created_at:_node.created_at,gate_id:_node.gate_id,multi:_node.multi,app_name:_node.app_name,session:_node.session,key:_node.key,multikey:_node.multikey,type:_node.type},action:"handshake",to:"exchange",from:"sgtway",marker:_node.marker},raw_data=JSON.stringify(lzw.pack(check));_REMOTE.publish("pingzee/auth/request/"+_node.type,raw_data),_REMOTE.subscribe("pingzee/auth/"+_node.gate_id+"/"+_node.session+"/"+_node.type+"/response")}}EventEmitter.call(_node),_node.key=opt.key,_node.multikey=null,_node.multi=opt.multi,_node.channels=opt.channels,_node.created_at=moment().format("hh:mm:ss:SS a  ddd"),_node.auth=!1,_node.gate_id=opt.gate_id,_node.marker=null,_node.control=null,_node.app_name=opt.app_name||"default",_node.type=opt.type||"fullflow",_node.session=uniqid(),_node.REMOTE=null,_node.init=function(done){for(var args=new Array(arguments.length),i=0;i<args.length;++i)args[i]=arguments[i];done="function"==typeof args[args.length-1]?args.pop():null,_node.REMOTE=mqtt.connect(REMOTE_ADDR,{keepalive:2,will:{topic:"pingzee/dead/gateway/software",payload:JSON.stringify({created_at:moment().format("hh:mm:ss:SS a  ddd"),key:_node.key,app_name:_node.app_name,gate_id:_node.gate_id,session:_node.session})}}),_node.REMOTE.on("connect",function(){handshake(this)}),_node.REMOTE.on("reconnect",function(){_node.emit("error","Network is unavilable , trying to reconnect"),_node.auth=!1}),_node.REMOTE.on("message",function(topic,message,pkt){switch(topic){case"pingzee/"+_node.control+"/control/emergency/broadcast":if(_node.auth&&("inflow"==_node.type||"fullflow"==_node.type||"outflow"==_node.type)){var raw_data=JSON.parse(message.toString()),main_Data=lzw.unpack(raw_data);m("Emergency Msg"),m(main_Data),_node.emit("emergency",main_Data.data.msg.message)}break;case"pingzee/control/rehandshake/broadcast":case"pingzee/"+_node.control+"/control/rehandshake/"+_node.gate_id+"/"+_node.session+"/response":!_node.auth||"inflow"!=_node.type&&"fullflow"!=_node.type&&"outflow"!=_node.type||handshake(this);break;case"pingzee/auth/"+_node.gate_id+"/"+_node.session+"/"+_node.type+"/response":raw_data=JSON.parse(message.toString()),main_Data=lzw.unpack(raw_data);if(m("Rx Handshake"),m(main_Data),_node.auth=main_Data.data.auth,_node.multi=main_Data.info.multi,_node.control=main_Data.control,_node.emit("handshake",{success:_node.auth,comment:"Handshake"+(_node.auth?" successfull":" failed")}),done)return _node.auth?(this.subscribe("pingzee/"+_node.control+"/message/"+_node.gate_id+"/"+_node.session+"/response"),this.subscribe("pingzee/control/+/broadcast"),main_Data.info.multi&&main_Data.info.multikey&&(_node.multikey=main_Data.info.multikey,this.subscribe("pingzee/"+_node.control+"/message/"+_node.key+"/"+_node.multikey+"/response")),this.subscribe("pingzee/control/rehandshake/"+_node.gate_id+"/"+_node.session+"/response"),done(null,{success:_node.auth,comment:"Handshake"+(_node.auth?" successfull":" failed")})):done({success:_node.auth,comment:"Handshake"+(_node.auth?" successfull":" failed")},null);break;case"pingzee/"+_node.control+"/message/"+_node.gate_id+"/"+_node.session+"/response":if(_node.auth&&("inflow"==_node.type||"fullflow"==_node.type)){raw_data=JSON.parse(message.toString()),main_Data=lzw.unpack(raw_data);m("Rx Msg"),m(main_Data),_node.emit(main_Data.data.msg.channel,main_Data.data.msg.message)}break;case"pingzee/"+_node.control+"/message/"+_node.key+"/"+_node.multikey+"/response":if(_node.auth&&("inflow"==_node.type||"fullflow"==_node.type)&&_node.multi){raw_data=JSON.parse(message.toString()),main_Data=lzw.unpack(raw_data);m("Rx Msg"),m(main_Data),_node.emit(main_Data.data.msg.channel,main_Data.data.msg.message)}}})},_node.send=function(message,channel,recipient,done){for(var action="data",args=new Array(arguments.length),i=0;i<args.length;++i)args[i]=arguments[i];if(done="function"==typeof args[args.length-1]?args.pop():null,message=args.length>0?args.shift():_node.app_name+" says you are awesome ! ",channel=args.length>0?args.shift():"data",recipient=args.length>0?args.shift():null,_.contains(["data","query","add","remove","join","delete"],channel)&&(action=channel),_node.auth){if("outflow"==_node.type||"fullflow"==_node.type){var check={data:{msg:{message:message,channel:channel,recipient:recipient},auth:_node.status,custom:[]},info:{created_at:moment().format(" hh:mm:ss:SS a  ddd"),gate_id:_node.gate_id,multi:_node.multi,app_name:_node.app_name,session:_node.session,key:_node.key,type:_node.type},action:action,to:"exchange",from:"sgtway",marker:_node.marker,control:_node.control},raw_data=JSON.stringify(lzw.pack(check));if(_node.REMOTE.publish("pingzee/"+_node.control+"/"+_node.type+"/data",raw_data),_node.emit("status","Message sent by Node-key:"+_node.key),done)return done(null,{success:!0,comment:"Message sent"})}else if(_node.emit("error","Node is "+_node.type+" type , can't send message"),done)return done({success:!1,comment:"Node is "+_node.type+"type , can't send message"},null)}else if(_node.emit("error","Node-key "+_node.key+" is not authorized , can't send message"),done)return done({success:!1,comment:"Node-key "+_node.key+" is not authorized , can't send message"},null)}}REMOTE_ADDR="undefined"==typeof window?"mqtt://iot.eclipse.org":"ws://iot.eclipse.org:80/ws",util.inherits(Gateway,EventEmitter),Gateway.prototype.node_list=[],util.inherits(node,EventEmitter),Gateway.prototype.connectNode=function(opt){if("string"==typeof opt||void 0===opt){var err={status:!1,comment:"TypeError:parameter type is "+typeof opt+" , Json Object required"};return e(err),err}var checkNode=_.findWhere(this.node_list,{key:opt.key});if(void 0===checkNode){var newConnection={};newConnection.key=opt.key,newConnection.multi=void 0!==opt.multi&&opt.multi,newConnection.gate_id=this.gate_id,newConnection.type=opt.type,newConnection.channels=void 0===opt.channels||0==opt.channels.length?["data","query","add","remove","join","delete"]:_.union(["data","add","remove","query","join","delete"],opt.channels),newConnection.app_name=uniqid("Pingzee-");var newNode=new node(newConnection);return this.node_list.push(newNode),m(this.gate_id),newNode}return checkNode},module.exports=Gateway;
